<?xml version="1.0" encoding="utf-8"?> <!DOCTYPE html> <html lang="en"> <head> <title>CapeDwarf Blog · CapeDwarf</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="https://static.jboss.org/wildfly/css/bootstrap-community.min.css" media="screen" rel="stylesheet"> <link href="/stylesheets/bootstrap-community-overrides.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="https://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="https://static.jboss.org/capedwarf/images//favicon.ico" rel="shortcut icon"> <link href="https://static.jboss.org/capedwarf/images//apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="https://static.jboss.org/capedwarf/images//apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="https://static.jboss.org/capedwarf/images//apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="https://static.jboss.org/capedwarf/images//apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <style>
      @media (min-width: 980px) {
        .banner { background-image: url(https://static.jboss.org/capedwarf/images//capedwarf-banner-1180px.png); height: 110px; }
      }
      @media (max-width: 979px) {
        .banner { background-image: url(https://static.jboss.org/capedwarf/images//capedwarf-logo.png); background-repeat:no-repeat; height: 60px; }
      }
      @media (max-width: 650px) {
        .banner { width: 200px; margin: 0px auto; }
      }
    </style> <script src="https://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <link href="http://capedwarf.org/stylesheets/blog.css" rel="stylesheet" type="text/css"> <link href="http://capedwarf.org/stylesheets/asciidoctor-coderay.css" media="screen" rel="stylesheet" type="text/css"> <style>
      td.download-size {
        text-align: right;
        padding-right: 10px;
      } 
      
      .white-stripes tr:nth-child(even) {
        background-color: white;
      }
      .white-stripes tr:nth-child(odd) {
        background-color: none;
      }
    </style> </head> <body> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="dropup"> <a class="tabnav-closed" href="https://www.redhat.com" id="tab">Red Hat</a> </div> <div class="banner"> <a href="#"></a> <div class="taglinelight visible-desktop">Google App Engine apps on your own private cloud</div> </div> <div class="navbar navbar-inverse" id="navbar-fix"> <div class="navbar-inner"> <div class="container"> <a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </a> <div class="nav-collapse collapse"> <ul class="nav" id="nav"> <li class=""><a href="http://capedwarf.org/">Home</a></li> <li class=""><a href="http://capedwarf.org/about/">About</a></li> <li class=""><a href="http://capedwarf.org/news/">News</a></li> <li class=""><a href="http://capedwarf.org/downloads/">Downloads</a></li> <li class=""><a href="http://capedwarf.org/documentation/">Documentation</a></li> <li class=""><a href="http://capedwarf.org/gethelp/">Get Help</a></li> <li class=""><a href="http://capedwarf.org/source/">Source Code</a></li> <li class="active"><a href="http://capedwarf.org/blog/">Blog</a></li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="#">Follow Us <b class="caret"></b></a> <ul class="dropdown-menu projectsocialmedia"> <li><a href="https://twitter.com/search?q=%23capedwarf"><img src="https://static.jboss.org/theme/images/common/socialmedia_icon40_twitter.png"></a></li> <li><a href="https://plus.google.com/communities/105087865153736312459"><img src="https://static.jboss.org/theme/images/common/socialmedia_icon40_googleplus.png"></a></li> </ul> </li> </ul> </div> </div> </div> </div> <div class='breadcrumb'><a class='breadcrumb_anchor ' href='http://capedwarf.org/index.html'>Index</a> / <a class='breadcrumb_anchor ' href='http://capedwarf.org/blog/index.html'>CapeDwarf Blog</a> / <a class='breadcrumb_anchor ' href='http://capedwarf.org/blog/tags/index.html'>Tags</a> / <a class='breadcrumb_anchor active' href='http://capedwarf.org/blog/tags/inside-capedwarf/index.html'>inside-capedwarf</a></div> <div class="row-fluid"> <div class="visible-desktop project-title-desktop"> <div class="pull-left"> <h1>CapeDwarf Blog</h1> </div> </div> <div class="hidden-desktop"> <div class="project-title-phone text-center"> <div> <h1>CapeDwarf Blog</h1> </div> </div> </div> </div> <span id="page"></span> <div class="row-fluid"> <div class="span8"> <div class="row-fluid"> <div class="span12 well post-bg"> <div class="post"> <h2 class="title"> <a href="http://capedwarf.org/blog/2013/11/13/ImplementingCapeDwarfsUsersAPIWithPicketLinkSocialsOpenIDSupport/">Implementing CapeDwarf&#8217;s Users API with PicketLink-Social&#8217;s OpenID support</a> </h2> <div class="byline"> <p> Posted by Marko Luksa on Nov 13, 2013 <a class="label label-info pull-right blah" href="http://capedwarf.org/blog/tags/blog/">blog</a> <span class="pull-right">&nbsp;</span> <a class="label label-info pull-right blah" href="http://capedwarf.org/blog/tags/inside-capedwarf/">inside-capedwarf</a> <span class="pull-right">&nbsp;</span> <a class="label label-info pull-right blah" href="http://capedwarf.org/blog/tags/users/">users</a> <span class="pull-right">&nbsp;</span> <a class="label label-info pull-right blah" href="http://capedwarf.org/blog/tags/picketlink/">picketlink</a> <span class="pull-right">&nbsp;</span> <a class="label label-info pull-right blah" href="http://capedwarf.org/blog/tags/openid/">openid</a> <span class="pull-right">&nbsp;</span> </p> </div> <p> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p><a href="http://www.jboss.org/capedwarf">JBoss CapeDwarf</a> is an implementation of the Google App Engine API, which allows applications written for the Google App Engine to be deployed on JBoss Application Servers without modification. Behind the scenes, CapeDwarf uses existing JBoss APIs such as Infinispan, JGroups, PicketLink, HornetQ and others.</p> </div> </div> </div> <div class="sect1"> <h2 id="the-users-api"><a class="anchor" href="#the-users-api"></a>The Users API</h2> <div class="sectionbody"> <div class="paragraph"> <p>One of the smallest APIs of the Google App Engine in terms of the number of API methods is the Users API. It basically contains only the following API methods: |getLoginUrl|, |getCurrentUser| and |getLogoutUrl|. By using the Users API, the application developer need not implement any kind of login system, because authentication is handled by AppEngine itself. Instead of directing the user to a custom login form, the application simply needs to point the user to the URL returned by |getLoginUrl|. This will allow the user to log in with either their Google account, their Google Apps Domain account or through an external OpenID provider. After the user logs in, they are redirected back to the application. The application can then obtain the logged-in user’s email address simply by calling the |getCurrentUser| API method.</p> </div> <div class="paragraph"> <p>In order to allow migration of existing GAE applications to and from CapeDwarf, CapeDwarf must also support using Google accounts and not introduce any custom method(s) of user authentication. Thanks to OpenID support in PicketLink Social this was pretty straightforward to achieve.</p> </div> <div class="paragraph"> <p>OpenID is an open standard that allows users to be authenticated by a trusted third party service. In CapeDwarf’s case, the third party service is the Google Accounts OpenID provider.</p> </div> <div class="paragraph"> <p>Using PicketLink Social to authenticate the user through Google Accounts is a very simple process.</p> </div> </div> </div> <div class="sect1"> <h2 id="directing-the-user-to-the-openid-provider-s-authentication-page"><a class="anchor" href="#directing-the-user-to-the-openid-provider-s-authentication-page"></a>Directing the user to the OpenID provider&#8217;s authentication page</h2> <div class="sectionbody"> <div class="paragraph"> <p>When the user requests the login URL returned by |getLoginUrl|, CapeDwarf’s AuthServlet instantiates an instance of PicketLink Social’s |OpenIDManager|, associates it with CapeDwarf’s own implementation of |OpenIDProtocolAdapter| and then simply instructs the |OpenIDManager| to authenticate the user:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">OpenIDManager manager = <span style="color:#080;font-weight:bold">new</span> OpenIDManager(<span style="color:#080;font-weight:bold">new</span> OpenIDRequest(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">https://www.google.com/accounts/o8/id</span><span style="color:#710">&quot;</span></span>));&#x000A;CapedwarfOpenIDProtocolAdaptor adapter = <span style="color:#080;font-weight:bold">new</span> CapedwarfOpenIDProtocolAdaptor(request, response, getReturnUrl(request));&#x000A;OpenIDManager.OpenIDProviderList providers = manager.discoverProviders();&#x000A;OpenIDManager.OpenIDProviderInformation providerInfo = manager.associate(adapter, providers);&#x000A;manager.authenticate(adapter, providerInfo);</code></pre> </div> </div> <div class="paragraph"> <p>Behind the scenes, the manager calls the |OpenIDProtocolAdapter| and instructs it to redirect the user to the OpenID provider’s URL. The redirect is achieved either through a standard HTTP redirect or by sending a self-submitting HTML form to the browser (this is necessary when the OpenID payload is larger than 2048 bytes).</p> </div> <div class="paragraph"> <p>The OpenID provider then displays the login form to the user (or authenticates the user in some other way).</p> </div> </div> </div> <div class="sect1"> <h2 id="handling-the-user-s-return-from-the-openid-provider-s-authentication-page"><a class="anchor" href="#handling-the-user-s-return-from-the-openid-provider-s-authentication-page"></a>Handling the user&#8217;s return from the OpenID provider&#8217;s authentication page</h2> <div class="sectionbody"> <div class="paragraph"> <p>After the user is authenticated successfully, the provider redirects the browser back to the consumer - CapeDwarf. This returning request is also handled by AuthServlet. The servlet verifies if the user is authenticated by calling verify() on the |OpenIDManager|. If the user has been authenticated, CapeDwarf can now access the email address of the authenticated user, store it in the session and redirect the browser to the destination URL that was supplied by the application when it requested the login URL in the first step.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span style="color:#339;font-weight:bold">boolean</span> authenticated = manager.verify(adapter, getStringToStringParameterMap(request), getFullRequestURL(request));&#x000A;<span style="color:#080;font-weight:bold">if</span> (authenticated) {&#x000A;    response.sendRedirect(request.getParameter(AuthServlet.DESTINATION_URL_PARAM));&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>During the invocation of the verify() method, the manager calls back our |OpenIDProtocolAdapter| with two types of |OpenIDLifecycleEvents|: |SESSION| and |SUCCESS|. The |SESSION| events instruct the adapter to store certain data in the session, while the |SUCCESS| event obviously signals that the authentication was successful.</p> </div> <div class="paragraph"> <p>The authentication process has now completed. Whenever the application now calls the User API’s |getCurrentUser| method, CapeDwarf will return the authenticated user’s email address. The email address simply identifies the user. It is up to the application to use this information whichever way it wants to.</p> </div> </div> </div> <div class="sect1"> <h2 id="how-we-handle-application-admins"><a class="anchor" href="#how-we-handle-application-admins"></a>How we handle application admins</h2> <div class="sectionbody"> <div class="paragraph"> <p>On a final note, there is another API method that I haven’t mentioned yet: |isUserAdmin|. As is obvious from the method’s name, this method returns true if the logged in user is the admin of the application - either the Google user that uploaded the application to Google’s AppSpot or another user that was manually added as an admin by the application uploader through the Google Cloud Console.</p> </div> <div class="paragraph"> <p>Since there is no user account/email associated with deploying an AppEngine application to CapeDwarf, there is no notion of an admin. To specify who the app’s admins are, you need to list their email addresses in capedwarf-web.xml like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">&lt;capedwarf-web-app&gt;&#x000A;    &lt;admin&gt;my.email<span style="color:#007">@gmail</span>.com&lt;/admin&gt;&#x000A;    &lt;admin&gt;another.admin.email<span style="color:#007">@gmail</span>.com&lt;/admin&gt;&#x000A;&lt;/capedwarf-web-app&gt;</code></pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="further-info"><a class="anchor" href="#further-info"></a>Further info</h2> <div class="sectionbody"> <div class="paragraph"> <p>For the complete source code of how CapeDwarf uses PicketLink Social, please turn to the <a href="https://github.com/capedwarf/capedwarf-blue/tree/master/users/src/main/java/org/jboss/capedwarf/users">Users module</a> in CapeDwarf’s <a href="https://github.com/capedwarf/capedwarf-blue">GitHub repo</a></p> </div> </div> </div> </p> </div> </div> </div> <div class="pagination no-bottom-margin"> <ul> <li class="disabled"> <a href="#">&laquo; Newer</a> </li> <li> <a href="#">Page 1 of 2</a> </li> <li> <a href="http://capedwarf.org/blog/tags/inside-capedwarf/page/2/">Older &raquo;</a> </li> </ul> </div> </div> <div class="span4"> <div class="row-fluid"> <div class="span12 well post-bg"> <h2> Latest Blog Posts <a class="rss" href="http://capedwarf.org/blog.atom"> <i class="icon-rss"></i> </a> </h2> <ul class="listPosts"> <li> <span class="name">Marko Luksa</span> <span class="meta">Nov 13, 2013</span> <a href="http://capedwarf.org/blog/2013/11/13/ImplementingCapeDwarfsUsersAPIWithPicketLinkSocialsOpenIDSupport/">Implementing CapeDwarf&#8217;s Users API with PicketLink-Social&#8217;s OpenID support</a> </li> <li> <span class="name">Marko Luksa</span> <span class="meta">Dec 11, 2012</span> <a href="http://capedwarf.org/blog/2012/12/11/2012-12-1-InsideCapeDwarfHowWeImplementedTheDatastoreAPI/">Inside CapeDwarf: How we implemented the Datastore API</a> </li> <li> <a class="pull-right" href="http://capedwarf.org/blog">More &raquo;</a> </li> </ul> </div> </div> <div class="row-fluid"> <div class="span12 well post-bg"> <h2>All Tags</h2> <div class="tag-cloud"> <span class="tag tag-6"> <a href="http://capedwarf.org/blog/tags/blog/">blog</a> </span> <span class="tag tag-0"> <a href="http://capedwarf.org/blog/tags/datastore/">datastore</a> </span> <span class="tag tag-6"> <a href="http://capedwarf.org/blog/tags/inside-capedwarf/">inside-capedwarf</a> </span> <span class="tag tag-0"> <a href="http://capedwarf.org/blog/tags/openid/">openid</a> </span> <span class="tag tag-0"> <a href="http://capedwarf.org/blog/tags/picketlink/">picketlink</a> </span> <span class="tag tag-0"> <a href="http://capedwarf.org/blog/tags/users/">users</a> </span> </div> </div> </div> </div> </div> </div> <footer class="container"> <div class="row-fluid"> <div class="span2 offset1"> <h4>Navigate</h4> <ul> <li> <a href="http://capedwarf.org/about/" title="About">About</a> </li> <li> <a href="http://capedwarf.org/gethelp/" title="Get Help">Get Help</a> </li> <li> <a href="https://community.jboss.org/en/capedwarf?view=discussion" title="Forums">Forums</a> </li> <li> <a href="http://capedwarf.org/downloads/" title="Download">Download</a> </li> </ul> </div> <div class="span2"> <h4>Follow Us</h4> <ul> <li> <a href="http://capedwarf.org/news/" title="News">News</a> <a href="http://capedwarf.org/news.atom" title="Atom">(Atom Feed)</a> </li> <li> <a href="https://twitter.com/search?q=%23capedwarf" title="Twitter">Twitter</a> </li> <li> <a href="https://plus.google.com/communities/105087865153736312459" title="Google+">Google+</a> </li> </ul> </div> <div class="span2"> <h4>Contribute</h4> <ul> <li> <a href="https://issues.jboss.org/browse/CAPEDWARF" title="Submit a bug">Submit a bug</a> </li> <li> <a href="https://github.com/capedwarf" title="Fork">Fork The Code</a> </li> </ul> </div> <div class="span3 offset1"> <h4>LGPL 2.1 License</h4> <p>All dependencies of this project are available under the LGPL or a compatible license.</p> </div> </div> <div class="row-fluid"> <div class="span6 offset1"> <p style="margin-top: 5px; font-size: 80%;"> © Copyright 2013 Red Hat, Inc. <br> <i class="icon-fire"></i> Made with <a href="https://github.com/jbossorg/bootstrap-community" style="text-decoration: underline;">JBoss Community Bootstrap</a> and <a href="http://awestruct.org/" style="text-decoration: underline;">Awestruct</a> <br> <i class="icon-globe"></i> This website is open source! If you want to improve it, <a href="http://github.com/capedwarf/capedwarf.org" style="text-decoration: underline;">fork the project,</a> and send a pull request. <br> <i class="icon-share"></i> Website released under <a href="http://creativecommons.org/licenses/by/3.0/" style="text-decoration: underline;">CC BY 3.0.</a> </p> </div> <div class="span3 offset1"> <div class="jbossbadge"> <a href="http://www.jboss.org/"> <img src="https://static.jboss.org/theme/images/common/jbossbadge.png"> </a> </div> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="http://www.redhat.com/"><img src="https://static.jboss.org/theme/images/common/redhat_logo.png"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="https://static.jboss.org/theme/js/libs/bootstrap-community/2.3.1.4/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='http://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='http://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
      var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
      var urlSplit = coreUrl.toLowerCase().split(/\//);
      var urlLast = urlSplit[urlSplit.length-1];
      var pageNameString = "";
      var siteName = "";
      var minorSectionIndex = 3
      if (urlLast == "") {
          urlSplit.splice(-1,1);
      }
      if (urlLast.search(/\./) >= 0) {
          if (urlLast == "index.html") {
              urlSplit.splice(-1,1);
          }
          else {
              urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
          }
      }
      siteName = urlSplit[2].split(".")[1];
      s.prop14 = s.eVar27 = siteName || "";
      s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
      s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
      pageNameString = urlSplit.splice(3).join(" | ");
      s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
      s.server = "jboss";
      s.channel = "jboss | community";
      s.prop4 = s.eVar23 = encodeURI(document.URL);
      s.prop21 = s.eVar18 = coreUrl;
      s.prop2 = s.eVar22 = "en";
      s.prop3 = s.eVar19 = "us";
      //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
      if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
      //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script> <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-40221748-1");
    pageTracker._trackPageview();
    } catch(err) {}</script> </body> </html>