<?xml version="1.0" encoding="utf-8"?> <!DOCTYPE html> <html lang="en"> <head> <title>CapeDwarf Blog · CapeDwarf</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="http://static.jboss.org/wildfly/css/bootstrap-community.min.css" media="screen" rel="stylesheet"> <link href="/stylesheets/bootstrap-community-overrides.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="http://static.jboss.org/capedwarf/images//favicon.ico" rel="shortcut icon"> <link href="http://static.jboss.org/capedwarf/images//apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="http://static.jboss.org/capedwarf/images//apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="http://static.jboss.org/capedwarf/images//apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="http://static.jboss.org/capedwarf/images//apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <style>
      @media (min-width: 980px) {
        .banner { background-image: url(http://static.jboss.org/capedwarf/images//capedwarf-banner-1180px.png); height: 110px; }
      }
      @media (max-width: 979px) {
        .banner { background-image: url(http://static.jboss.org/capedwarf/images//capedwarf-logo.png); background-repeat:no-repeat; height: 60px; }
      }
      @media (max-width: 650px) {
        .banner { width: 200px; margin: 0px auto; }
      }
    </style> <script src="http://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <link href="http://capedwarf.org/stylesheets/blog.css" rel="stylesheet" type="text/css"> <link href="http://capedwarf.org/stylesheets/asciidoctor-coderay.css" media="screen" rel="stylesheet" type="text/css"> <style>
      td.download-size {
        text-align: right;
        padding-right: 10px;
      } 
      
      .white-stripes tr:nth-child(even) {
        background-color: white;
      }
      .white-stripes tr:nth-child(odd) {
        background-color: none;
      }
    </style> </head> <body> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="dropup"> <a class="tabnav-closed" href="https://www.redhat.com" id="tab">Red Hat</a> </div> <div class="banner"> <a href="#"></a> <div class="taglinelight visible-desktop">Google App Engine apps on your own private cloud</div> </div> <div class="navbar navbar-inverse" id="navbar-fix"> <div class="navbar-inner"> <div class="container"> <a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </a> <div class="nav-collapse collapse"> <ul class="nav" id="nav"> <li class=""><a href="http://capedwarf.org/">Home</a></li> <li class=""><a href="http://capedwarf.org/about/">About</a></li> <li class=""><a href="http://capedwarf.org/news/">News</a></li> <li class=""><a href="http://capedwarf.org/downloads/">Downloads</a></li> <li class=""><a href="http://capedwarf.org/documentation/">Documentation</a></li> <li class=""><a href="http://capedwarf.org/gethelp/">Get Help</a></li> <li class=""><a href="http://capedwarf.org/source/">Source Code</a></li> <li class="active"><a href="http://capedwarf.org/blog/">Blog</a></li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="#">Follow Us <b class="caret"></b></a> <ul class="dropdown-menu projectsocialmedia"> <li><a href="https://twitter.com/search?q=%23capedwarf"><img src="http://static.jboss.org/theme/images/common/socialmedia_icon40_twitter.png"></a></li> <li><a href="https://plus.google.com/communities/105087865153736312459"><img src="http://static.jboss.org/theme/images/common/socialmedia_icon40_googleplus.png"></a></li> </ul> </li> </ul> </div> </div> </div> </div> <div class='breadcrumb'><a class='breadcrumb_anchor ' href='http://capedwarf.org/index.html'>Index</a> / <a class='breadcrumb_anchor ' href='http://capedwarf.org/blog/index.html'>CapeDwarf Blog</a> / <a class='breadcrumb_anchor ' href='http://capedwarf.org/blog/tags/index.html'>Tags</a> / <a class='breadcrumb_anchor ' href='http://capedwarf.org/blog/tags/blog/index.html'>CapeDwarf Blog</a> / <a class='breadcrumb_anchor active' href='http://capedwarf.org/blog/tags/blog/page/2/index.html'>blog</a></div> <div class="row-fluid"> <div class="visible-desktop project-title-desktop"> <div class="pull-left"> <h1>CapeDwarf Blog</h1> </div> </div> <div class="hidden-desktop"> <div class="project-title-phone text-center"> <div> <h1>CapeDwarf Blog</h1> </div> </div> </div> </div> <span id="page"></span> <div class="row-fluid"> <div class="span8"> <div class="row-fluid"> <div class="span12 well post-bg"> <div class="post"> <h2 class="title"> <a href="http://capedwarf.org/blog/2012/12/11/2012-12-1-InsideCapeDwarfHowWeImplementedTheDatastoreAPI/">Inside CapeDwarf: How we implemented the Datastore API</a> </h2> <div class="byline"> <p> Posted by Marko Luksa on Dec 11, 2012 <a class="label label-info pull-right blah" href="http://capedwarf.org/blog/tags/blog/">blog</a> <span class="pull-right">&nbsp;</span> <a class="label label-info pull-right blah" href="http://capedwarf.org/blog/tags/inside-capedwarf/">inside-capedwarf</a> <span class="pull-right">&nbsp;</span> <a class="label label-info pull-right blah" href="http://capedwarf.org/blog/tags/datastore/">datastore</a> <span class="pull-right">&nbsp;</span> </p> </div> <p> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>Inside CapeDwarf is a series of blog posts about the internals of the CapeDwarf project. CapeDwarf is an open-source implementation of Google App Engine APIs on top of various JBoss technologies. You&#8217;ll find more info on CapeDwarf at the project&#8217;s page at <a href="http://www.jboss.org/capedwarf">http://www.jboss.org/capedwarf</a></p> </div> </div> </div> <div class="sect1"> <h2 id="appengine-datastore-api"><a class="anchor" href="#appengine-datastore-api"></a>AppEngine Datastore API</h2> <div class="sectionbody"> <div class="paragraph"> <p>The single most important AppEngine API is probably the Datastore API, which (as evident from the name itself) provides an API for storing, retrieving and querying data. This was the first API we set out to implement in CapeDwarf. It basically served as proof-of-concept for the whole project.</p> </div> <div class="paragraph"> <p>Those familiar with JBoss technologies will know that JBoss already has an existing project that would offer most of the things needed to implement the Datastore API - <a href="http://www.jboss.org/infinispan">Infinispan</a>. Infinispan is an extremely scalable, highly available key/value NoSQL datastore and distributed data grid platform. So basically Infinispan offers everything we need - all we needed to do is implement an adapter between Infinispan and the Datastore API.</p> </div> </div> </div> <div class="sect1"> <h2 id="hacking-into-google-s-factories"><a class="anchor" href="#hacking-into-google-s-factories"></a>Hacking into Google&#8217;s factories</h2> <div class="sectionbody"> <div class="paragraph"> <p>No, of course I&#8217;m not talking about breaking into Google&#8217;s real-world facilities. What I am talking about are all the XYServiceFactory classes in the AppEngine API. They represent the entry point into the API and have methods like getXYService(), which you use to obtain references to all the various services the API has to offer. One of those factories is the DatastoreServiceFactory, which we needed to force into returning our own custom implementation of DatastoreService, so that every time anyone would call DatastoreServiceFactory.getDatastoreService(), they would get the reference to CapeDwarf&#8217;s implementation of the service.</p> </div> <div class="paragraph"> <p>Since the factory itself is not configurable and always returns Google&#8217;s own implementation of DatastoreService, we needed to resort to bytecode manipulation of the factory. Javassist made this pretty simple - we simply replaced the whole body of the getDatastoreService method, so it would create a new CapedwarfDatastoreService instance and return it.</p> </div> <div class="paragraph"> <p>We used the same technique with all the other XYFactory.getXYService() methods.</p> </div> </div> </div> <div class="sect1"> <h2 id="making-sure-we-re-actually-implementing-the-api-correctly"><a class="anchor" href="#making-sure-we-re-actually-implementing-the-api-correctly"></a>Making sure we&#8217;re actually implementing the API correctly</h2> <div class="sectionbody"> <div class="paragraph"> <p>Much of the coding was done TDD style. We used JUnit and Arquillian, which enables you to programatically create micro-deployments, automatically deploy them to a running application server and run tests inside the deployment. Initially, we only ran the tests against CapeDwarf and JBossAS7.1, but later also added the option of running the same tests against Google&#8217;s own development app-server and even the production system (appspot). This ability to run our tests against the real Google App Engine proved to be extremely valuable, as it allowed us to validate our tests and to see if our implementation of the GAE API was aligned with that of GAE itself.</p> </div> <div class="paragraph"> <p>Of course, it&#8217;s hard to write perfect tests based only on API documentation, which usually doesn&#8217;t go into every implementation detail of the API. This meant that when we initially ran the tests against the real GAE, quite a few of them actually failed, even though they had been passing against CapeDwarf. There were minor differences between Google&#8217;s and CapeDwarf&#8217;s implementation of the API, and through the tests, we were able to pin-point the differences and iron-out CapeDwarf so it would behave exactly like GAE. This would have been a lot harder if we had not had Arquillian at our disposal.</p> </div> </div> </div> <div class="sect1"> <h2 id="storing-and-retrieving-data"><a class="anchor" href="#storing-and-retrieving-data"></a>Storing and retrieving data</h2> <div class="sectionbody"> <div class="paragraph"> <p>OK, let&#8217;s finally move on to the actual implementation of the datastore. The most basic operations of the Datastore are storing and retrieving Entity objects by key. Implementing this with Infinispan was very straight-forward, since Infinispan exposes a Cache interface, which extends java.util.Map. So, basically, implementing datastore&#8217;s get and put methods was as simple as invoking put and get on a Map. It really doesn&#8217;t get any easier than this.</p> </div> <div class="paragraph"> <p>One caveat that would reveal itself later is that by default Infinispan does not make a defensive copy when you store an object in the cache. This means any modification made to the object after storing it would also be seen by clients retrieving the object from the cache (this is only true if the object hasn&#8217;t been passivated and is being accessed on the same node in the cluster). We could have used Infinispan&#8217;s storeAsBinary option, but we figured it was faster to simply clone the Entity prior to storing and returning it, since the clone() method was already implemented on Entity.</p> </div> </div> </div> <div class="sect1"> <h2 id="querying"><a class="anchor" href="#querying"></a>Querying</h2> <div class="sectionbody"> <div class="paragraph"> <p>With the basic operations implemented (storing, retrieving and deleting entities by their keys), we moved on to the hard(er) part - querying. Infinispan-Query and <a href="http://www.hibernate.org/subprojects/search.html">Hibernate-Search</a> already offered the ability to index the properties of entities into a Lucene index and perform queries against this index and then retrieve the results from the Infinispan cache.</p> </div> <div class="paragraph"> <p>In order to make Infinispan index the entities, we needed to add a few annotations to the Entity class. We accomplished this through bytecode manipulation with Javassist as well. Since every datastore Entity can have a completely dynamic set of properties (the properties don&#8217;t have to be specified up-front in any kind of schema), we needed to implement a Hibernate-Search Field Bridge that would map all the properties of the Entity to a Lucene document.</p> </div> <div class="paragraph"> <p>With the entities now stored in the cache as well as in the Lucene index, all that was left to do was implement a query converter that would convert Google App Engine queries into Infinispan&#8217;s cache-queries. Actually, Infinispan&#8217;s CacheQuery is not much more than a wrapper around a Lucene query, so the converter actually converts GAE queries into Lucene queries. It does this through a DSL provided by Hibernate-Search.</p> </div> </div> </div> <div class="sect1"> <h2 id="appengine-splits-certain-types-of-queries-capedwarf-doesn-t-need-to"><a class="anchor" href="#appengine-splits-certain-types-of-queries-capedwarf-doesn-t-need-to"></a>AppEngine splits certain types of queries, CapeDwarf doesn&#8217;t need to</h2> <div class="sectionbody"> <div class="paragraph"> <p>One interesting thing about Google&#8217;s implementation of Datastore queries is the fact that certain types of queries (IN, OR, NOT_EQUAL) are split up into multiple queries with the results then merged into a single result set. We opted not to do this, since Infinispan-Query/Hibernate-Search/Lucene are quite capable of doing this in a single query. However, there is a problem with using this single-query approach with queries containing the IN operator. Since GAE performs multiple queries in this case, the order of the results depends on the order of the items in the IN list. Since this is clearly documented in the GAE documentation and certain applications may depend on this, we were forced to implement sorting of the results according to the same rules. While this is not really a problem when queries return whole entities, it is quite a pain when performing projection queries (these queries return only a subset of the entity&#8217;s properties). When a client performs a projection query returning property <em>foo</em>, and filtering (with an IN operator) on property <em>bar</em>, we have to add <em>bar</em> to the list of requested projection properties, just so we can sort the results according to the order of items in the IN clause. In hindsight, maybe we should have simply gone the same route as GAE does and split these kinds of queries into multiple queries as well. It is possible we will do this in the future.</p> </div> </div> </div> <div class="sect1"> <h2 id="wrap-up"><a class="anchor" href="#wrap-up"></a>Wrap-up</h2> <div class="sectionbody"> <div class="paragraph"> <p>This was a quick look at how we implemented the Datastore API in CapeDwarf. I didn&#8217;t cover Datastore statistics, Callbacks and Metadata yet. These are fairly recent additions to the Datastore API and I&#8217;ll go into how we implemented them in one of my future "Inside CapeDwarf" blog posts.</p> </div> <div class="paragraph"> <p>If any of you have an application running on Google App Engine, we&#8217;d really appreciate it if you could give CapeDwarf a try and report to us any problems you encounter. For detailed instructions on how to run your app on CapeDwarf, see Aleš Justin&#8217;s recent <a href="http://in.relation.to/Bloggers/FirstCapeDwarfRelease">blog post</a> about the first CapeDwarf release.</p> </div> </div> </div> </p> </div> </div> </div> <div class="pagination no-bottom-margin"> <ul> <li> <a href="http://capedwarf.org/blog/tags/blog/">&laquo; Newer</a> </li> <li> <a href="#">Page 2 of 2</a> </li> <li class="disabled"> <a href="#">Older &raquo;</a> </li> </ul> </div> </div> <div class="span4"> <div class="row-fluid"> <div class="span12 well post-bg"> <h2> Latest Blog Posts <a class="rss" href="http://capedwarf.org/blog.atom"> <i class="icon-rss"></i> </a> </h2> <ul class="listPosts"> <li> <span class="name">Marko Luksa</span> <span class="meta">Nov 13, 2013</span> <a href="http://capedwarf.org/blog/2013/11/13/ImplementingCapeDwarfsUsersAPIWithPicketLinkSocialsOpenIDSupport/">Implementing CapeDwarf&#8217;s Users API with PicketLink-Social&#8217;s OpenID support</a> </li> <li> <span class="name">Marko Luksa</span> <span class="meta">Dec 11, 2012</span> <a href="http://capedwarf.org/blog/2012/12/11/2012-12-1-InsideCapeDwarfHowWeImplementedTheDatastoreAPI/">Inside CapeDwarf: How we implemented the Datastore API</a> </li> <li> <a class="pull-right" href="http://capedwarf.org/blog">More &raquo;</a> </li> </ul> </div> </div> <div class="row-fluid"> <div class="span12 well post-bg"> <h2>All Tags</h2> <div class="tag-cloud"> <span class="tag tag-6"> <a href="http://capedwarf.org/blog/tags/blog/">blog</a> </span> <span class="tag tag-0"> <a href="http://capedwarf.org/blog/tags/datastore/">datastore</a> </span> <span class="tag tag-6"> <a href="http://capedwarf.org/blog/tags/inside-capedwarf/">inside-capedwarf</a> </span> <span class="tag tag-0"> <a href="http://capedwarf.org/blog/tags/openid/">openid</a> </span> <span class="tag tag-0"> <a href="http://capedwarf.org/blog/tags/picketlink/">picketlink</a> </span> <span class="tag tag-0"> <a href="http://capedwarf.org/blog/tags/users/">users</a> </span> </div> </div> </div> </div> </div> </div> <footer class="container"> <div class="row-fluid"> <div class="span2 offset1"> <h4>Navigate</h4> <ul> <li> <a href="http://capedwarf.org/about/" title="About">About</a> </li> <li> <a href="http://capedwarf.org/gethelp/" title="Get Help">Get Help</a> </li> <li> <a href="https://community.jboss.org/en/capedwarf?view=discussion" title="Forums">Forums</a> </li> <li> <a href="http://capedwarf.org/downloads/" title="Download">Download</a> </li> </ul> </div> <div class="span2"> <h4>Follow Us</h4> <ul> <li> <a href="http://capedwarf.org/news/" title="News">News</a> <a href="http://capedwarf.org/news.atom" title="Atom">(Atom Feed)</a> </li> <li> <a href="https://twitter.com/search?q=%23capedwarf" title="Twitter">Twitter</a> </li> <li> <a href="https://plus.google.com/communities/105087865153736312459" title="Google+">Google+</a> </li> </ul> </div> <div class="span2"> <h4>Contribute</h4> <ul> <li> <a href="https://issues.jboss.org/browse/CAPEDWARF" title="Submit a bug">Submit a bug</a> </li> <li> <a href="https://github.com/capedwarf" title="Fork">Fork The Code</a> </li> </ul> </div> <div class="span3 offset1"> <h4>LGPL 2.1 License</h4> <p>All dependencies of this project are available under the LGPL or a compatible license.</p> </div> </div> <div class="row-fluid"> <div class="span6 offset1"> <p style="margin-top: 5px; font-size: 80%;"> © Copyright 2013 Red Hat, Inc. <br> <i class="icon-fire"></i> Made with <a href="https://github.com/jbossorg/bootstrap-community" style="text-decoration: underline;">JBoss Community Bootstrap</a> and <a href="http://awestruct.org/" style="text-decoration: underline;">Awestruct</a> <br> <i class="icon-globe"></i> This website is open source! If you want to improve it, <a href="http://github.com/capedwarf/capedwarf.org" style="text-decoration: underline;">fork the project,</a> and send a pull request. <br> <i class="icon-share"></i> Website released under <a href="http://creativecommons.org/licenses/by/3.0/" style="text-decoration: underline;">CC BY 3.0.</a> </p> </div> <div class="span3 offset1"> <div class="jbossbadge"> <a href="http://www.jboss.org/"> <img src="http://static.jboss.org/theme/images/common/jbossbadge.png"> </a> </div> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="http://www.redhat.com/"><img src="http://static.jboss.org/theme/images/common/redhat_logo.png"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="http://static.jboss.org/theme/js/libs/bootstrap-community/2.3.1.4/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='http://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='http://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
      var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
      var urlSplit = coreUrl.toLowerCase().split(/\//);
      var urlLast = urlSplit[urlSplit.length-1];
      var pageNameString = "";
      var siteName = "";
      var minorSectionIndex = 3
      if (urlLast == "") {
          urlSplit.splice(-1,1);
      }
      if (urlLast.search(/\./) >= 0) {
          if (urlLast == "index.html") {
              urlSplit.splice(-1,1);
          }
          else {
              urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
          }
      }
      siteName = urlSplit[2].split(".")[1];
      s.prop14 = s.eVar27 = siteName || "";
      s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
      s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
      pageNameString = urlSplit.splice(3).join(" | ");
      s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
      s.server = "jboss";
      s.channel = "jboss | community";
      s.prop4 = s.eVar23 = encodeURI(document.URL);
      s.prop21 = s.eVar18 = coreUrl;
      s.prop2 = s.eVar22 = "en";
      s.prop3 = s.eVar19 = "us";
      //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
      if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
      //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script> <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-40221748-1");
    pageTracker._trackPageview();
    } catch(err) {}</script> </body> </html>